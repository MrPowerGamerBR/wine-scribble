From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MrPowerGamerBR <git@mrpowergamerbr.com>
Date: Sun, 4 Jan 2026 02:51:27 -0300
Subject: Gracefully handle zero size palette resizes

Fixes "double free detected" when trying deleting a palette that was previously resized to zero

Fixes Monster Truck Madness 2
---
 dlls/win32u/palette.c | 19 ++++++++++++-------
 1 file changed, 12 insertions(+), 7 deletions(-)

diff --git a/dlls/win32u/palette.c b/dlls/win32u/palette.c
index 4809b954fdf..5e84c0f38b0 100644
--- a/dlls/win32u/palette.c
+++ b/dlls/win32u/palette.c
@@ -227,14 +227,19 @@ BOOL WINAPI NtGdiResizePalette( HPALETTE hPal, UINT count )
     if( !palPtr ) return FALSE;
     TRACE("hpal = %p, prev = %i, new = %i\n", hPal, palPtr->count, count );
 
-    if (!(entries = realloc( palPtr->entries, count * sizeof(*palPtr->entries) )))
-    {
-        GDI_ReleaseObj( hPal );
-        return FALSE;
+    if (count != 0) {
+        if (!(entries = realloc( palPtr->entries, count * sizeof(*palPtr->entries) )))
+        {
+            GDI_ReleaseObj( hPal );
+            return FALSE;
+        }
+        if (count > palPtr->count)
+            memset( entries + palPtr->count, 0, (count - palPtr->count) * sizeof(*palPtr->entries) );
+        palPtr->entries = entries;
+    } else {
+        free( palPtr->entries );
+        palPtr->entries = NULL;
     }
-    if (count > palPtr->count)
-        memset( entries + palPtr->count, 0, (count - palPtr->count) * sizeof(*palPtr->entries) );
-    palPtr->entries = entries;
     palPtr->count = count;
 
     GDI_ReleaseObj( hPal );
-- 
2.52.0

